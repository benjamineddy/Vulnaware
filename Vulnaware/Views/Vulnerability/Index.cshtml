@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div id="page-wrapper">
    <br />
    <h2>Vulnerability Search</h2>
    <br />
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-green">
                <div class="panel-heading">
                    Vulnerabilities
                </div>
                <!-- /.panel-heading -->
                <div class="panel-body">
                    <table style="width:100%;" class="table table-striped table-bordered table-hover" id="vulnerabilities">
                        <thead>
                            <tr>
                                <th>CVEID</th>
                                <th>CVE ID</th>
                                <th>Base Score</th>
                                <th>Published Date</th>
                                <th>Access Complexity</th>
                                <th>Access Vector</th>
                                <th>Authentication</th>
                                <th>Availability Impact</th>
                                <th>Confidentiality Impact</th>
                                <th>Integrity Impact</th>
                                <th>Details/Track</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <!-- /.table-responsive -->
                </div>
                <!-- /.panel-body -->
                <div id="action-configuration-div" style="display:none">
                    <img style="display:block; margin-left:auto; margin-right:auto" src="~/images/loader.gif" alt="Actioning..." />
                </div>
                <br />
            </div>
            <!-- /.panel -->
        </div>
        <!-- /.col-lg-12 -->
    </div>
    @section scripts {
        @if (SignInManager.IsSignedIn(User))
        {
            <script>
                var isSignedIn = true;
            </script>
        }
        else
        {
            <script>
                var isSignedIn = false;
            </script>
        }
        <script>
            $(document).ready(function () {
                $("#vulnerabilities").DataTable({
                    "processing": true, // for show progress bar
                    "serverSide": true, // for process server side
                    "filter": true, // this is for disable filter (search box)
                    "orderMulti": false, // for disable multiple column at once
                    "scrollX": true,
                    "ajax": {
                        "url": "/Vulnerability/LoadData",
                        "type": "POST",
                        "datatype": "json"
                    },
                    "columnDefs":
                    [
                        {
                            "targets": [0],
                            "visible": false,
                            "searchable": false
                        },
                        {
                            "targets": [4, 5, 6, 7, 8, 9, 10],
                            "orderable": false
                        }
                    ],
                    "columns": [
                        { "data": "cveID", "name": "CveID", "autoWidth": true },
                        { "data": "givenID", "name": "GivenID", "autoWidth": true },
                        {
                            "name": "BaseScore",
                            "render": function (data, type, full, meta) {
                                if (full.baseScore <= 3) {
                                    return '<div class="progress"><div class="progress-bar progress-bar-success" role="progressbar" style="width:25%">' + full.baseScore + '</div></div>';
                                }
                                if (full.baseScore > 3 && full.baseScore <= 6) {
                                    return '<div class="progress"><div class="progress-bar" role="progressbar" style="width:50%">' + full.baseScore + '</div></div>';
                                }
                                if (full.baseScore > 6 && full.baseScore <= 9) {
                                    return '<div class="progress"><div class="progress-bar progress-bar-warning" role="progressbar" style="width:75%">' + full.baseScore + '</div></div>';
                                }
                                if (full.baseScore > 9) {
                                    return '<div class="progress"><div class="progress-bar progress-bar-danger" role="progressbar" style="width:100%">' + full.baseScore + '</div></div>';
                                }
                            }
                        },
                        {
                            "name": "PublishedDate",
                            "render": function (data, type, full, meta) {
                                return new Date(full.publishedDate).toLocaleDateString("en-GB")
                            }
                        },
                        { "data": "accessComplexity", "name": "AccessComplexity", "autoWidth": true },
                        { "data": "accessVector", "name": "AccessVector", "autoWidth": true },
                        { "data": "authentication", "name": "Authentication", "autoWidth": true },
                        { "data": "availabilityImpact", "name": "AvailabilityImpact", "autoWidth": true },
                        { "data": "confidentialityImpact", "name": "ConfidentialityImpact", "autoWidth": true },
                        { "data": "integrityImpact", "name": "IntegrityImpact", "autoWidth": true },
                        {
                            "render": function (data, type, full, meta) {
                                if (isSignedIn == true)
                                {
                                    CheckExistingTracking(full.cveID);
                                    return '<a class="btn btn-info" href="/Vulnerability/Details/' + full.cveID + '">Details</a> <button style="width:70px;" Id="btnTrack' + full.cveID + '" type="button" class="btn btn-success" onclick=ChangeTracking(' + full.cveID + '); >Track</button>';
                                } else
                                {
                                    return '<a class="btn btn-info" href="/Vulnerability/Details/' + full.cveID + '">Details</a>';
                                }
                            }
                        },
                    ]
                });
                });
            function ChangeTracking(cveID)
            {
                $.ajax({
                    url: '@Url.Action("ChangeVulnerabilityTracking")',
                    type: "POST",
                    data: { cveId: cveID },
                    success: function (result) {
                        if (result.returnValue == "Added") { // now being tracked
                            document.getElementById("btnTrack" + cveID).innerHTML = "Untrack";
                            document.getElementById("btnTrack" + cveID).className = "btn btn-primary";
                        } else { // no longer tracked
                            document.getElementById("btnTrack" + cveID).innerHTML = "Track";
                            document.getElementById("btnTrack" + cveID).className = "btn btn-success";
                        }
                        
                    },
                    error: function (data) {
                        alert("Something went wrong, please try again.");
                    }
                })
            }

            function CheckExistingTracking(cveID)
            {
                $.ajax({
                    url: '@Url.Action("CheckExistingTracking")',
                    type: "POST",
                    data: { cveId: cveID },
                    success: function (data) {
                        if (data == true) {
                            document.getElementById("btnTrack" + cveID).innerHTML = "Untrack";
                            document.getElementById("btnTrack" + cveID).className = "btn btn-primary";
                        }
                    },
                    error: function (data) {
                        alert("Something went wrong, please try again.");
                    }
                })
            }
        </script>
    }
</div>

